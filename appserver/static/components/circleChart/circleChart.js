define(function(require,module){var _=require('underscore'),$=require('jquery');var d3=require("../d3/d3.v3.min");var SimpleSplunkView=require('splunkjs/mvc/simplesplunkview');var Drilldown=require('splunkjs/mvc/drilldown');require("css!./circle_packing.css");var CircleChart=SimpleSplunkView.extend({moduleId:module.id,className:'circlechart-viz',options:{data:'preview'},output_mode:'json',createView:function(){this.$el.html('');var svg=d3.select(this.el).append("svg").attr("width",500).attr("height",500);return{container:this.$el,svg:svg};},formatData:function(data){var newData={name:"root",children:[]},levels=["categoryId","name"];data.forEach(function(d){var depthCursor=newData.children;levels.forEach(function(property,depth){var index;depthCursor.forEach(function(child,i){if(d[property]==child.name)index=i;});if(isNaN(index)){depthCursor.push({name:d[property],children:[]});index=depthCursor.length-1;} depthCursor=depthCursor[index].children;if(depth===levels.length-1)depthCursor.push({name:d.product_name,size:d.count});});});return newData;},updateView:function(viz,data){var diameter=500,format=d3.format(",d");var pack=d3.layout.pack().size([diameter-4,diameter-4]).value(function(d){return d.size;});var svg=$(viz.svg[0]);svg.empty();var svg=viz.svg.append("g").attr("transform","translate(2,2)");var node=svg.datum(data).selectAll(".node").data(pack.nodes).enter().append("g").attr("class",function(d){return d.children?"node":"leaf node";}).attr("transform",function(d){return"translate("+d.x+","+d.y+")";});node.append("title").text(function(d){return d.name+(d.children?"":": "+format(d.size));});node.append("circle").attr("class","circle-class").attr("r",function(d){return d.r;});node.filter(function(d){return!d.children;}).append("text").attr("dy",".3em").style("text-anchor","middle").text(function(d){return d.name.substring(0,d.r/3);});d3.select(self.frameElement).style("height",diameter+"px");}});return CircleChart;});