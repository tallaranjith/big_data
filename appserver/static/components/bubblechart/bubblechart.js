define(function(require,exports,module){var _=require('underscore');var d3=require("../d3/d3.min");var SimpleSplunkView=require("splunkjs/mvc/simplesplunkview");require("css!./bubblechart.css");var BubbleChart=SimpleSplunkView.extend({className:"splunk-toolkit-bubble-chart",options:{managerid:null,data:"preview",nameField:null,valueField:'count',categoryField:null},output_mode:"json",initialize:function(){_.extend(this.options,{formatName:_.identity,formatTitle:function(d){return(d.source.name+' -> '+d.target.name+': '+d.value);}});SimpleSplunkView.prototype.initialize.apply(this,arguments);this.settings.enablePush("value");this.settings.on("change:valueField",this.render,this);this.settings.on("change:nameField",this.render,this);this.settings.on("change:categoryField",this.render,this);$(window).resize(this,_.debounce(this._handleResize,20));},_handleResize:function(e){e.data.render();},createView:function(){var margin={top:0,right:0,bottom:0,left:0};var availableWidth=parseInt(this.settings.get("width")||this.$el.width());var availableHeight=parseInt(this.settings.get("height")||this.$el.height());this.$el.html("");var svg=d3.select(this.el).append("svg").attr("width",availableWidth).attr("height",availableHeight).attr("pointer-events","all");var tooltip=d3.select(this.el).append("div").attr("class","bubble-chart-tooltip");return{container:this.$el,svg:svg,margin:margin,tooltip:tooltip};},formatData:function(data){var nameField=this.settings.get('nameField');var valueField=this.settings.get('valueField');var categoryField=this.settings.get('categoryField');var collection=data;var bubblechart={'name':nameField+"s",'children':[]};for(var i=0;i<collection.length;i++){var Idx=-1;$.each(bubblechart.children,function(idx,el){if(el.name==collection[i][categoryField]){Idx=idx;}});if(Idx==-1){bubblechart.children.push({'name':collection[i][categoryField],children:[]});Idx=bubblechart.children.length-1;} bubblechart.children[Idx].children.push({'name':collection[i][nameField],'size':collection[i][valueField]||1});} return bubblechart;},updateView:function(viz,data){var that=this;var svg=$(viz.svg[0]);svg.empty();var tooltip=viz.tooltip;var graph=viz.svg.append("g").attr("class","bubble").attr("transform","translate("+viz.margin.left+","+viz.margin.top+")");var format=d3.format(",d");var color=d3.scale.category20c();var containerHeight=this.$el.height();var containerWidth=this.$el.width();var diameter=Math.min(containerWidth,containerHeight);var bubble=d3.layout.pack().sort(null).size([diameter,diameter]).padding(1.5);var width=bubble.size()[0];var height=bubble.size()[1];graph.attr("width",width).attr("height",height);svg.height(height);svg.width(width);var node=graph.selectAll(".node").data(bubble.nodes(classes(data)).filter(function(d){return!d.children;})).enter().append("g").attr("class","node").attr("transform",function(d){return"translate("+d.x+","+d.y+")";});node.append("circle").attr("r",function(d){return d.r;}).style("fill",function(d){return color(d.packageName);});node.append("text").attr("dy",".3em").style("text-anchor","middle").text(function(d){return(d.className+" "+format(d.value)).substring(0,d.r/3.5);});function classes(data){var classes=[];function recurse(name,node){if(node.children) node.children.forEach(function(child){recurse(node.name,child);});else classes.push({packageName:name||"",className:node.name||"",value:node.size});} recurse(null,data);return{children:classes};} function doMouseEnter(d){var text;if(d.className===undefined||d.className===""){text="Event: "+d.value;}else{text=d.className+": "+d.value;} tooltip.text(text).style("opacity",function(){if(d.value!==undefined){return 1;} return 0;}).style("left",(d3.mouse(that.el)[0])+"px").style("top",(d3.mouse(that.el)[1])+"px");} function doMouseOut(d){tooltip.style("opacity",1e-6);} node.on("mouseover",doMouseEnter);node.on("mouseout",doMouseOut);node.on('click',function(e){var clickEvent={name:e.className,category:e.packageName,value:e.value};that.settings.set("value",e.className);that.trigger("click",clickEvent);});}});return BubbleChart;});